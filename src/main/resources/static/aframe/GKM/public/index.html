<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room</title>

    <!-- A-Frame ë° ì»´í¬ë„ŒíŠ¸ ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>
    <script src="/js/hitboxes.js"></script>
    
    <!-- ìºë¦­í„° ì›€ì§ì„ ì»¨íŠ¸ë¡¤ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • -->
    <script>
      let gameStarted = false; // ê²Œì„ ì‹œì‘ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜ ì¶”ê°€
      
      AFRAME.registerComponent('character-movement', {
        init: function () {
          this.model = this.el;
          this.speed = 0.2;
          this.moveVector = new THREE.Vector3();
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ë¥¼ ìœ„í•œ ë³€ìˆ˜ë“¤
          this.isMouseDown = false;
          this.previousMouseX = 0;
          this.previousMouseY = 0;
          this.mouseSensitivity = 0.002;
          this.rotationX = 0; // ìƒí•˜ íšŒì „ì„ ìœ„í•œ ë³€ìˆ˜ ì¶”ê°€
          
          // ì í”„ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
          this.isJumping = false;
          this.jumpVelocity = 0;
          this.jumpSpeed = 0.2;
          this.gravity = 0.006;
          this.groundLevel = 0;
          
          // í‚¤ë³´ë“œ ìƒíƒœ ì¶”ì ì— ìŠ¤í˜ì´ìŠ¤ë°” ì¶”ê°€
          this.keys = {
            w: false,
            s: false,
            a: false,
            d: false,
            ' ': false  // ìŠ¤í˜ì´ìŠ¤ ë°”
          };
          
          // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
          document.addEventListener('keydown', (e) => {
            if (this.keys.hasOwnProperty(e.key.toLowerCase())) {
              this.keys[e.key.toLowerCase()] = true;
            }
          });
          
          document.addEventListener('keyup', (e) => {
            if (this.keys.hasOwnProperty(e.key.toLowerCase())) {
              this.keys[e.key.toLowerCase()] = false;
            }
          });
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
          document.addEventListener('mousedown', (e) => {
            this.isMouseDown = true;
            this.previousMouseX = e.clientX;
            this.previousMouseY = e.clientY;

          });
          
          document.addEventListener('mouseup', () => {
            this.isMouseDown = false;
          });
          
          document.addEventListener('mousemove', (e) => {
            if (this.isMouseDown) {
              const deltaX = e.clientX - this.previousMouseX;
              const deltaY = e.clientY - this.previousMouseY;
              
              // ì¢Œë¦­í„° ìì²´ë¥¼ íšŒì „
              this.model.object3D.rotation.y -= deltaX * this.mouseSensitivity;
              
              // ìƒí•˜ ì‹œì ì€ ì¹´ë©”ë¼ì—ë§Œ ì ìš©
              this.rotationX -= deltaY * this.mouseSensitivity;
              this.rotationX = Math.max(-Math.PI / 3, Math.min(Math.PI / 3, this.rotationX));
              const camera = document.querySelector('#camera');
              if (camera) {
                camera.object3D.rotation.x = this.rotationX;
              }
              
              this.previousMouseX = e.clientX;
              this.previousMouseY = e.clientY;
            }
          });
          
          // ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ ì¶”ê°€
          this.currentAnimation = 'Idle0';
          this.model.addEventListener('model-loaded', () => {
            this.mixer = new THREE.AnimationMixer(this.model.object3D);
            this.animations = this.model.getObject3D('mesh').animations;
            this.actions = {};
            
            // ëª¨ë“  ì• ë‹ˆë©”ì´ì…˜ ì•¡ì…˜ ìƒì„±
            this.animations.forEach(animation => {
              this.actions[animation.name] = this.mixer.clipAction(animation);
            });
            
            // ì´ˆê¸° Idle ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            this.playAnimation('Idle0');
          });
          
          this.rotationSpeed = 2; // íšŒì „ ì†ë„
        },
        
        playAnimation: function(newAnim) {
          if (this.currentAnimation === newAnim) return;
          
          // ì´ì „ ì• ë‹ˆë©”ì´ì…˜ í˜ì´ë“œì•„ì›ƒ
          if (this.actions[this.currentAnimation]) {
            this.actions[this.currentAnimation].fadeOut(0.2);
          }
          
          // ìƒˆ ì• ë‹ˆë©”ì´ì…˜ í˜ì´ë“œì¸
          if (this.actions[newAnim]) {
            this.actions[newAnim].reset().fadeIn(0.2).play();
            this.currentAnimation = newAnim;
          }
        },
        
        tick: function(time, deltaTime) {
          // ì¼ì‹œì •ì§€ ìƒíƒœ í™•ì¸
          if (this.el.sceneEl.components['game-manager'].isPaused) {
              return;
          }
          
          // ì´ë™ ë°©í–¥ ê³„ì‚°
          this.moveVector.set(0, 0, 0);
          
          // ì¹´ë©”ë¼ì˜ íšŒì „ê°’ ê°€ì ¸ì˜¤ê¸°
          const camera = document.querySelector('#camera');
          const cameraRotation = camera.object3D.rotation.y;
          
          // ì „ì§„/í›„ì§„ (ë¶€í˜¸ ë³€ê²½)
          if (this.keys.w) this.moveVector.z = -this.speed;   // ì „ì§„
          if (this.keys.s) this.moveVector.z = this.speed;    // í›„ì§„
          // ì¢Œìš° ì´ë™
          if (this.keys.a) this.moveVector.x = -this.speed;   // ì™¼ìª½
          if (this.keys.d) this.moveVector.x = this.speed;    // ì˜¤ë¥¸ìª½
          
          // ì¹´ë©”ë¼ ë°©í–¥ì„ ê¸°ì¤€ìœ¼ë¡œ ì´ë™ ë²¡í„° íšŒì „
          const rotationMatrix = new THREE.Matrix4();
          rotationMatrix.makeRotationY(cameraRotation);
          this.moveVector.applyMatrix4(rotationMatrix);
          
          // ì í”„ ì²˜ë¦¬
          if (this.keys[' '] && !this.isJumping) {
              this.isJumping = true;
              this.jumpVelocity = this.jumpSpeed;
          }
          
          if (this.isJumping) {
              this.model.object3D.position.y += this.jumpVelocity;
              this.jumpVelocity -= this.gravity;
              
              if (this.model.object3D.position.y <= this.groundLevel) {
                  this.model.object3D.position.y = this.groundLevel;
                  this.isJumping = false;
                  this.jumpVelocity = 0;
              }
          }
          
          // ì´ë™ ì „ í˜„ì¬ ìœ„ì¹˜ ì €ì¥
          const previousPosition = this.model.object3D.position.clone();
          
          // ì´ë™ ì ìš©
          this.model.object3D.position.x += this.moveVector.x;
          this.model.object3D.position.z += this.moveVector.z;
          
          // ì´ë™ ë°©í–¥ìœ¼ë¡œ ìºë¦­í„° íšŒì „
          if (Math.abs(this.moveVector.x) > 0.001 || Math.abs(this.moveVector.z) > 0.001) {
              const angle = Math.atan2(this.moveVector.x, this.moveVector.z);
              this.model.object3D.rotation.y = angle;
          }
          
          // ì• ë‹ˆë©”ì´ì…˜ ì—…ë°ì´íŠ¸
          if (this.mixer) {
              this.mixer.update(deltaTime / 1000);
              
              if (this.isJumping) {
                  this.playAnimation('Jumping0');
              } else if (Math.abs(this.moveVector.x) > 0.01 || Math.abs(this.moveVector.z) > 0.01) {
                  this.playAnimation('Walking0');
              } else {
                  this.playAnimation('Idle0');
              }
          }
        }
      });
    </script>

    <!-- ì¹´ë©”ë¼ íŒ”ë¡œìš° ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • -->
    <script>
      AFRAME.registerComponent('unreal-camera-control', {
        schema: {
          target: { type: 'selector' },
          distance: { type: 'number', default: 5 },
          height: { type: 'number', default: 3.5 },
          rotationSpeed: { type: 'number', default: 0.002 },
          smoothFactor: { type: 'number', default: 0.1 },
          tiltAngle: { type: 'number', default: 10 }
        },

        init: function() {
          this.currentRotation = new THREE.Euler();
          this.targetRotation = new THREE.Euler();
          this.mouseX = 0;
          this.mouseY = 0;
          this.targetPosition = new THREE.Vector3();
          this.currentPosition = new THREE.Vector3();
          this.isMouseDown = false;
          
          // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •
          document.addEventListener('mousedown', (e) => {
            if (e.button === 2) { // ì˜¤ë¥¸ìª½ ë§ˆìš°ìŠ¤ ë²„íŠ¼
              this.isMouseDown = true;
              this.mouseX = e.clientX;
              this.mouseY = e.clientY;
            }
          });
          
          document.addEventListener('mouseup', (e) => {
            if (e.button === 2) { // ì˜¤ë¥¸ìª½ ë§ˆìš°ìŠ¤ ë²„íŠ¼
              this.isMouseDown = false;
            }
          });
          
          document.addEventListener('mousemove', (e) => {
            if (this.isMouseDown) {
              const deltaX = e.clientX - this.mouseX;
              
              // deltaXì˜ ë¶€í˜¸ë¥¼ ë°˜ëŒ€ë¡œ ë³€ê²½
              this.targetRotation.y -= deltaX * this.data.rotationSpeed;
              
              this.mouseX = e.clientX;
              this.mouseY = e.clientY;
            }
          });
          
          // ì˜¤ë¥¸ìª½ í´ë¦­ ë©”ë‰´ ë°©ì§€ëŠ” ìœ ì§€
          document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
          });
        },

        tick: function() {
          if (!this.data.target) return;
          
          // ë¶€ë“œëŸ¬ìš´ ì¹´ë©”ë¼ íšŒì „ (ì¢Œìš°ë§Œ)
          this.currentRotation.y += (this.targetRotation.y - this.currentRotation.y) * this.data.smoothFactor;
          
          // íƒ€ê²Ÿ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
          this.data.target.object3D.getWorldPosition(this.targetPosition);
          
          // ì¹´ë©”ë¼ ìœ„ì¹˜ ê³„ì‚°
          const offset = new THREE.Vector3(
            0,
            this.data.height,
            -this.data.distance
          );
          
          // íšŒì „ ì ìš© (ì¢Œìš°ë§Œ)
          offset.applyEuler(new THREE.Euler(0, this.currentRotation.y, 0));
          
          // ë¶€ë“œëŸ¬ìš´ ì¹´ë©”ë¼ ì´ë™
          this.currentPosition.x += (this.targetPosition.x + offset.x - this.currentPosition.x) * this.data.smoothFactor;
          this.currentPosition.y += (this.targetPosition.y + offset.y - this.currentPosition.y) * this.data.smoothFactor;
          this.currentPosition.z += (this.targetPosition.z + offset.z - this.currentPosition.z) * this.data.smoothFactor;
          
          // ì¹´ë©”ë¼ ìœ„ì¹˜ì™€ íšŒì „ ì—…ë°ì´íŠ¸ (ì¢Œìš° íšŒì „ + ê³ ì •ëœ í•˜í–¥ ê°ë„)
          this.el.object3D.position.copy(this.currentPosition);
          this.el.object3D.rotation.set(
            THREE.MathUtils.degToRad(this.data.tiltAngle), // Xì¶• íšŒì „ (í•˜í–¥)
            this.currentRotation.y + Math.PI,  // Yì¶• íšŒì „
            0  // Zì¶• íšŒì „
          );
        }
      });
    </script>

    <!-- ê²Œì„ ìƒíƒœ ê´€ë¦¬ ì»´í¬ë„ŒíŠ¸ -->
    <script>
      AFRAME.registerComponent('game-manager', {
        init: function() {
          this.isGameOver = false;
          this.isGameStarted = false;
          this.playerName = '';
          this.zombieCount = 0;
          
          // ì‹œì‘ í™”ë©´ ìƒì„±
          this.createStartScreen();
          
          // ê²Œì„ UI ì»¨í…Œì´ë„ˆ ìƒì„±
          this.uiContainer = document.createElement('div');
          this.uiContainer.style.cssText = `
              position: fixed;
              top: 20px;
              left: 20px;
              color: white;
              font-family: 'Arial', sans-serif;
              font-size: 20px;
              display: none;
              background: rgba(0, 0, 0, 0.5);
              padding: 15px 20px;
              border-radius: 10px;
              backdrop-filter: blur(5px);
              box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
          `;
          
          // íƒ€ì´ë¨¸ ì—˜ë¦¬ë¨¼íŠ¸
          this.timerEl = document.createElement('div');
          this.timerEl.style.cssText = `
              margin-bottom: 8px;
              display: flex;
              align-items: center;
          `;
          this.timerEl.innerHTML = `
              <span style="color: #4CAF50;">â±</span>
              <span style="margin-left: 8px;">ìƒì¡´ ì‹œê°„: 0ì´ˆ</span>
          `;
          
          // ì¢€ë¹„ ì¹´ìš´í„° ì—˜ë¦¬ë¨¼íŠ¸
          this.zombieCounterEl = document.createElement('div');
          this.zombieCounterEl.style.cssText = `
              display: flex;
              align-items: center;
          `;
          this.zombieCounterEl.innerHTML = `
              <span style="color: #ff4444;">ğŸ§Ÿ</span>
              <span style="margin-left: 8px;">ì¢€ë¹„: 0ë§ˆë¦¬</span>
          `;
          
          // UI ìš”ì†Œë“¤ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
          this.uiContainer.appendChild(this.timerEl);
          this.uiContainer.appendChild(this.zombieCounterEl);
          document.body.appendChild(this.uiContainer);

          // ì¢€ë¹„ ìƒì„± ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          this.el.addEventListener('zombieSpawned', () => {
              this.zombieCount++;
          });

          this.isPaused = false;
          
          // ì¼ì‹œì •ì§€ UI ìƒì„±
          this.createPauseScreen();
          
          // ESC í‚¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.isGameStarted && !this.isGameOver) {
              this.togglePause();
            }
          });
        },

        createStartScreen: function() {
          const startScreen = document.createElement('div');
          startScreen.id = 'startScreen';
          startScreen.style.position = 'fixed';
          startScreen.style.top = '0';
          startScreen.style.left = '0';
          startScreen.style.width = '100%';
          startScreen.style.height = '100%';
          startScreen.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
          startScreen.style.display = 'flex';
          startScreen.style.flexDirection = 'column';
          startScreen.style.justifyContent = 'center';
          startScreen.style.alignItems = 'center';
          startScreen.style.zIndex = '1000';

          startScreen.innerHTML = `
            <h1 style="color: white; font-size: 3em; margin-bottom: 1em;">ì¢€ë¹„ íƒˆì¶œ ê²Œì„</h1>
            <div style="margin: 2em 0;">
              <input type="text" id="playerName" placeholder="í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" 
                     style="padding: 0.5em; font-size: 1.2em; margin-right: 1em;">
              <button id="startButton" 
                      style="padding: 0.5em 1em; font-size: 1.2em; background: #4CAF50; color: white; border: none; cursor: pointer;">
                ê²Œì„ ì‹œì‘
              </button>
            </div>
            <div style="color: white; text-align: center; margin-top: 2em;">
              <h2>ìµœê³  ê¸°ë¡ TOP 3</h2>
              <div style="
                max-height: 400px;
                overflow-y: auto;
                padding: 1em;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 10px;
                min-width: 300px;
              ">
                <ul id="leaderboardList" style="
                  list-style: none;
                  padding: 0;
                  margin: 0;
                  text-align: left;
                "></ul>
              </div>
            </div>
          `;

          document.body.appendChild(startScreen);

          // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          document.getElementById('startButton').addEventListener('click', () => {
            const name = document.getElementById('playerName').value.trim();
            if (name) {
              this.playerName = name;
              this.startGame();
            } else {
              alert('í”Œë ˆì´ì–´ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            }
          });

          // ì´ˆê¸° ë¦¬ë”ë³´ë“œ ë¡œë“œ
          this.loadLeaderboard();
        },

        startGame: function() {
          gameStarted = true;
          this.isGameStarted = true;
          this.startTime = Date.now();
          document.getElementById('startScreen').style.display = 'none';
          this.uiContainer.style.display = 'block';
          this.updateTimer();
          
          // ê²Œì„ ì‹œì‘ ì´ë²¤íŠ¸ ë°œìƒ
          this.el.emit('gameStarted');
        },

        updateTimer: function() {
          if (!this.isGameStarted || this.isGameOver || this.isPaused) return;
          
          const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
          this.timerEl.querySelector('span:last-child').textContent = `ìƒì¡´ ì‹œê°„: ${elapsed}ì´ˆ`;
          this.zombieCounterEl.querySelector('span:last-child').textContent = `ì¢€ë¹„: ${this.zombieCount}ë§ˆë¦¬`;
          
          requestAnimationFrame(this.updateTimer.bind(this));
        },

        async loadLeaderboard() {
          try {
            const response = await fetch('/api/records');
            const records = await response.json();
            
            const leaderboardList = document.getElementById('leaderboardList');
            leaderboardList.innerHTML = records
              .slice(0, 3)  // ìƒìœ„ 3ê°œë§Œ ì‚¬ìš©
              .map((record, index) => {
                const date = new Date(record.created_at);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                return `
                  <li style="
                    padding: 1em;
                    margin: 0.5em 0;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 5px;
                    font-size: 1.1em;
                  ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="color: ${
                        index === 0 ? '#ffd700' :  // ê¸ˆìƒ‰
                        index === 1 ? '#c0c0c0' :  // ì€ìƒ‰
                        index === 2 ? '#cd7f32' :  // ë™ìƒ‰
                        'white'
                      }">
                        ${index + 1}ìœ„ ${record.player_name}
                      </span>
                      <span style="color: #ff8888">
                        ${record.survival_time}ì´ˆ
                      </span>
                    </div>
                    <div style="
                      margin-top: 0.5em;
                      font-size: 0.9em;
                      color: #aaa;
                      display: flex;
                      justify-content: space-between;
                    ">
                      <span>ì¢€ë¹„: ${record.zombie_count}ë§ˆë¦¬</span>
                      <span>${formattedDate}</span>
                    </div>
                  </li>
                `;
              })
              .join('');
          } catch (error) {
            console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
          }
        },

        gameWin: function() {
          this.isGameOver = true;
          const clearTime = Math.floor((Date.now() - this.startTime) / 1000);
          
          // ê¸°ë¡ ì €ì¥ ë¨¼ì € ì‹¤í–‰
          fetch('/api/records', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              playerName: this.playerName,
              clearTime: clearTime
            })
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨');
            }
            return response.json();
          })
          .then(() => {
            // ìŠ¹ë¦¬ í™”ë©´ í‘œì‹œ
            const winScreen = document.createElement('div');
            winScreen.style.position = 'fixed';
            winScreen.style.top = '0';
            winScreen.style.left = '0';
            winScreen.style.width = '100%';
            winScreen.style.height = '100%';
            winScreen.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            winScreen.style.display = 'flex';
            winScreen.style.flexDirection = 'column';
            winScreen.style.justifyContent = 'center';
            winScreen.style.alignItems = 'center';
            winScreen.style.zIndex = '1000';

            winScreen.innerHTML = `
              <h1 style="color: #4CAF50; font-size: 3em; margin-bottom: 0.5em;">íƒˆì¶œ ì„±ê³µ!</h1>
              <p style="color: white; font-size: 1.5em; margin-bottom: 1em;">
                í”Œë ˆì´ì–´: ${this.playerName}<br>
                í´ë¦¬ì–´ ì‹œê°„: ${clearTime}ì´ˆ
              </p>
              <button id="restartButton" 
                      style="padding: 0.5em 1em; font-size: 1.2em; background: #4CAF50; 
                             color: white; border: none; cursor: pointer; margin-bottom: 2em;">
                ë‹¤ì‹œí•˜ê¸°
              </button>
              <div style="color: white; text-align: center;">
                <h2>í´ë¦¬ì–´ ëª©ë¡</h2>
                <ul id="winLeaderboardList" style="list-style: none; padding: 0; max-height: 300px; overflow-y: auto;"></ul>
              </div>
            `;

            document.body.appendChild(winScreen);

            // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('restartButton').addEventListener('click', () => {
              window.location.reload();
            });

            // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
            this.loadWinLeaderboard();
          })
          .catch(error => {
            console.error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ìŠ¹ë¦¬ í™”ë©´ì€ í‘œì‹œ
            this.showWinScreen(clearTime);
          });
        },

        // ìŠ¹ë¦¬ í™”ë©´ìš© ë¦¬ë”ë³´ë“œ ë¡œë“œ í•¨ìˆ˜
        async loadWinLeaderboard() {
          try {
            const response = await fetch('/api/records');
            const records = await response.json();
            
            const leaderboardList = document.getElementById('winLeaderboardList');
            leaderboardList.innerHTML = records
              .map((record, index) => `
                <li style="margin: 0.5em 0; font-size: 1.2em;">
                  ${index + 1}. ${record.player_name} - ${record.clear_time}ì´ˆ
                </li>
              `)
              .join('');
          } catch (error) {
            console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
          }
        },

        gameLose: function() {
          this.isGameOver = true;
          const survivalTime = Math.floor((Date.now() - this.startTime) / 1000);
          const currentDate = new Date();
          const formattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
          
          // ê¸°ë¡ ì €ì¥
          fetch('/api/records', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              playerName: this.playerName,
              clearTime: survivalTime,
              zombieCount: this.zombieCount
            })
          })
          .then(response => response.json())
          .then(() => {
            const gameOverScreen = document.createElement('div');
            gameOverScreen.style.position = 'fixed';
            gameOverScreen.style.top = '0';
            gameOverScreen.style.left = '0';
            gameOverScreen.style.width = '100%';
            gameOverScreen.style.height = '100%';
            gameOverScreen.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            gameOverScreen.style.display = 'flex';
            gameOverScreen.style.flexDirection = 'column';
            gameOverScreen.style.justifyContent = 'center';
            gameOverScreen.style.alignItems = 'center';
            gameOverScreen.style.zIndex = '1000';
            gameOverScreen.style.fontFamily = 'Arial, sans-serif';

            gameOverScreen.innerHTML = `
              <div style="background: rgba(0, 0, 0, 0.8); padding: 2em; border-radius: 15px; text-align: center; max-width: 80%;">
                <h1 style="color: #ff4444; font-size: 3em; margin-bottom: 0.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ê²Œì„ ì˜¤ë²„!</h1>
                
                <div style="color: white; font-size: 1.5em; margin-bottom: 1.5em; background: rgba(255, 255, 255, 0.1); padding: 1em; border-radius: 10px;">
                  <p style="margin: 0.5em 0;">í”Œë ˆì´ì–´: ${this.playerName}</p>
                  <p style="margin: 0.5em 0;">ìƒì¡´ ì‹œê°„: ${survivalTime}ì´ˆ</p>
                  <p style="margin: 0.5em 0;">ì²˜ì¹˜í•œ ì¢€ë¹„: ${this.zombieCount}ë§ˆë¦¬</p>
                  <p style="margin: 0.5em 0; color: #aaa;">í”Œë ˆì´ ë‚ ì§œ: ${formattedDate}</p>
                </div>

                <button onclick="location.reload(true)" 
                        style="padding: 1em 2em; 
                               font-size: 1.2em; 
                               background: #ff4444; 
                               color: white; 
                               border: none; 
                               border-radius: 5px;
                               cursor: pointer;
                               margin-bottom: 2em;
                               transition: background 0.3s;">
                  ë‹¤ì‹œ ë„ì „í•˜ê¸°
                </button>

                <div style="color: white; text-align: center; margin-top: 2em;">
                  <h2 style="color: #ffdd44; margin-bottom: 1em;">ìµœê³  ê¸°ë¡ TOP 3</h2>
                  <div style="
                    max-height: 300px;
                    overflow-y: auto;
                    padding: 1em;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 10px;
                  ">
                    <ul id="gameOverLeaderboardList" style="
                      list-style: none;
                      padding: 0;
                      margin: 0;
                      text-align: left;
                    "></ul>
                  </div>
                </div>
              </div>
            `;

            document.body.appendChild(gameOverScreen);

            // ê²Œì„ ì˜¤ë²„ í™”ë©´ì˜ ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
            this.loadGameOverLeaderboard();
          })
          .catch(error => {
            console.error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
          });
        },

        // ê²Œì„ ì˜¤ë²„ í™”ë©´ìš© ë¦¬ë”ë³´ë“œ ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
        async loadGameOverLeaderboard() {
          try {
            const response = await fetch('/api/records');
            const records = await response.json();
            
            const leaderboardList = document.getElementById('gameOverLeaderboardList');
            leaderboardList.innerHTML = records
              .slice(0, 3)  // ìƒìœ„ 3ê°œë§Œ ì‚¬ìš©
              .map((record, index) => {
                const date = new Date(record.created_at);
                const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                
                return `
                  <li style="
                    padding: 1em;
                    margin: 0.5em 0;
                    background: rgba(255, 255, 255, 0.05);
                    border-radius: 5px;
                    font-size: 1.1em;
                  ">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="color: ${
                        index === 0 ? '#ffd700' :  // ê¸ˆìƒ‰
                        index === 1 ? '#c0c0c0' :  // ì€ìƒ‰
                        index === 2 ? '#cd7f32' :  // ë™ìƒ‰
                        'white'
                      }">
                        ${index + 1}ìœ„ ${record.player_name}
                      </span>
                      <span style="color: #ff8888">
                        ${record.survival_time}ì´ˆ
                      </span>
                    </div>
                    <div style="
                      margin-top: 0.5em;
                      font-size: 0.9em;
                      color: #aaa;
                      display: flex;
                      justify-content: space-between;
                    ">
                      <span>ì¢€ë¹„: ${record.zombie_count}ë§ˆë¦¬</span>
                      <span>${formattedDate}</span>
                    </div>
                  </li>
                `;
              })
              .join('');
          } catch (error) {
            console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
          }
        },

        showMessage: function(text, color) {
          const messageEl = document.createElement('div');
          messageEl.style.position = 'fixed';
          messageEl.style.top = '50%';
          messageEl.style.left = '50%';
          messageEl.style.transform = 'translate(-50%, -50%)';
          messageEl.style.color = color;
          messageEl.style.fontSize = '48px';
          messageEl.style.fontWeight = 'bold';
          messageEl.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
          messageEl.textContent = text;
          document.body.appendChild(messageEl);
        },

        gameComplete: function() {
          if (!this.isGameStarted || this.isGameOver) return;
          
          this.isGameOver = true;
          const endTime = Date.now();
          const clearTime = Math.floor((endTime - this.startTime) / 1000); // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜
          
          // ê²Œì„ í´ë¦¬ì–´ í™”ë©´ í‘œì‹œ
          document.getElementById('gameOverScreen').style.display = 'flex';
          document.getElementById('gameOverMessage').textContent = `ì¶•í•˜í•©ë‹ˆë‹¤! ${clearTime}ì´ˆ ë§Œì— í´ë¦¬ì–´í•˜ì…¨ìŠµë‹ˆë‹¤!`;
          
          // í”Œë ˆì´ì–´ ì´ë¦„ ì…ë ¥ ë°›ê¸°
          const playerName = prompt('ê¸°ë¡ì„ ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:');
          if (playerName) {
            // ì„œë²„ë¡œ ê¸°ë¡ ì „ì†¡
            fetch('/api/records', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',              },
              body: JSON.stringify({
                playerName: playerName,
                clearTime: clearTime
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                // ìƒìœ„ ê¸°ë¡ í‘œì‹œ
                this.showTopRecords();
              } else {
                alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ê¸°ë¡ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
          }
        },

        // ìƒìœ„ ê¸°ë¡ í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
        showTopRecords: function() {
          fetch('/api/records')
            .then(response => response.json())
            .then(records => {
              let recordsHtml = '<h2>ìƒìœ„ ê¸°ë¡</h2><ul>';
              records.forEach((record, index) => {
                recordsHtml += `
                  <li>${index + 1}ìœ„: ${record.player_name} - ${record.clear_time}ì´ˆ</li>
                `;
              });
              recordsHtml += '</ul>';
              
              document.getElementById('recordsList').innerHTML = recordsHtml;
              document.getElementById('recordsList').style.display = 'block';
            })
            .catch(error => {
              console.error('Error:', error);
              alert('ê¸°ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        },

        createPauseScreen: function() {
          const pauseScreen = document.createElement('div');
          pauseScreen.id = 'pauseScreen';
          pauseScreen.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-family: Arial, sans-serif;
          `;

          pauseScreen.innerHTML = `
            <h1 style="color: white; font-size: 3em; margin-bottom: 1em;">ì¼ì‹œì •ì§€</h1>
            <div style="display: flex; flex-direction: column; gap: 1em;">
              <button id="resumeButton" style="
                padding: 0.8em 2em;
                font-size: 1.2em;
                background: #4CAF50;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.3s;
              ">ê²Œì„ ì¬ê°œ</button>
              <button id="restartButton" style="
                padding: 0.8em 2em;
                font-size: 1.2em;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.3s;
              ">ê²Œì„ ì¬ì‹œì‘</button>
            </div>
          `;

          document.body.appendChild(pauseScreen);

          // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          document.getElementById('resumeButton').addEventListener('click', () => {
            this.togglePause();
          });

          document.getElementById('restartButton').addEventListener('click', () => {
            window.location.reload();
          });

          // í˜¸ë²„ íš¨ê³¼
          const buttons = pauseScreen.querySelectorAll('button');
          buttons.forEach(button => {
            button.addEventListener('mouseover', () => {
              button.style.opacity = '0.9';
              button.style.transform = 'scale(1.05)';
            });
            button.addEventListener('mouseout', () => {
              button.style.opacity = '1';
              button.style.transform = 'scale(1)';
            });
          });
        },

        togglePause: function() {
          this.isPaused = !this.isPaused;
          const pauseScreen = document.getElementById('pauseScreen');
          
          if (this.isPaused) {
            pauseScreen.style.display = 'flex';
            // íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ì‹œê°„ ì €ì¥
            this.pauseStartTime = Date.now();
            this.el.emit('gamePaused');
          } else {
            pauseScreen.style.display = 'none';
            // ì¼ì‹œì •ì§€ëœ ì‹œê°„ë§Œí¼ ì‹œì‘ ì‹œê°„ ì¡°ì •
            const pauseDuration = Date.now() - this.pauseStartTime;
            this.startTime += pauseDuration;
            this.el.emit('gameResumed');
            // íƒ€ì´ë¨¸ ì¬ì‹œì‘
            this.updateTimer();
          }
        }
      });

      // ì¢€ë¹„ AI ì»´í¬ë„ŒíŠ¸
      AFRAME.registerComponent('zombie-ai', {
        schema: {
          target: {type: 'selector'},
          speed: {type: 'number', default: 0.1},
          detectionRange: {type: 'number', default: 99999},
          attackRange: {type: 'number', default: 1}
        },

        init: function() {
          this.zombie = this.el;
          this.moveVector = new THREE.Vector3();
          this.currentAnimation = '';
          this.isGameOver = false;
          this.targetPosition = new THREE.Vector3();
          this.zombiePosition = new THREE.Vector3();

          this.zombie.addEventListener('model-loaded', () => {
            console.log('Model loaded for zombie:', this.el.id);
            const model = this.zombie.getObject3D('mesh');
            this.mixer = new THREE.AnimationMixer(model);
            this.animations = model.animations;
            this.actions = {};
            
            this.animations.forEach(animation => {
              const action = this.mixer.clipAction(animation);
              action.setLoop(THREE.LoopRepeat);
              action.clampWhenFinished = true;
              action.timeScale = 1.0;
              this.actions[animation.name] = action;
            });
            
            this.playAnimation('ZombieRunning');
          });
        },

        tick: function(time, deltaTime) {
          // ì¼ì‹œì •ì§€ ìƒíƒœ í™•ì¸
          if (this.el.sceneEl.components['game-manager'].isPaused) {
            if (this.mixer) {
              this.mixer.timeScale = 0; // ì• ë‹ˆë©”ì´ì…˜ ì¼ì‹œì •ì§€
            }
            return;
          } else {
            if (this.mixer) {
              this.mixer.timeScale = 1; // ì• ë‹ˆë©”ì´ì…˜ ì¬ê°œ
            }
          }
          if (!this.mixer || !this.data.target) return;
          
          const delta = Math.min(deltaTime / 1000, 0.1);
          this.mixer.update(delta);
          
          if (this.el.sceneEl.components['game-manager'].isGameOver) {
            if (!this.isGameOver) {
              this.isGameOver = true;
              this.playAnimation('ZombieIdle');
            }
            return;
          }

          // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
          this.data.target.object3D.getWorldPosition(this.targetPosition);
          this.zombie.object3D.getWorldPosition(this.zombiePosition);
          
          // ì´ë™ ë°©í–¥ ê³„ì‚°
          this.moveVector.subVectors(this.targetPosition, this.zombiePosition).normalize();
          
          // ì´ë™ ì ìš©
          const moveAmount = this.data.speed * (deltaTime / 16.67);
          this.zombie.object3D.position.x += this.moveVector.x * moveAmount;
          this.zombie.object3D.position.z += this.moveVector.z * moveAmount;
          
          // í–¥ìƒëœ íšŒì „ ë¡œì§
          const dx = this.targetPosition.x - this.zombiePosition.x;
          const dz = this.targetPosition.z - this.zombiePosition.z;
          const targetAngle = Math.atan2(dx, dz);
          
          // ë¶€ë“œëŸ¬ìš´ íšŒì „ì„ ìœ„í•œ ë³´ê°„
          const currentRotation = this.zombie.object3D.rotation.y;
          const rotationDiff = targetAngle - currentRotation;
          
          // íšŒì „ê° ì •ê·œí™” (-PI to PI)
          let normalizedDiff = rotationDiff;
          while (normalizedDiff > Math.PI) normalizedDiff -= Math.PI * 2;
          while (normalizedDiff < -Math.PI) normalizedDiff += Math.PI * 2;
          
          // ë¶€ë“œëŸ¬ìš´ íšŒì „ ì ìš©
          const rotationSpeed = 0.1;
          this.zombie.object3D.rotation.y += normalizedDiff * rotationSpeed;
          
          // ê±°ë¦¬ ì²´í¬
          const distance = this.zombiePosition.distanceTo(this.targetPosition);
          
          if (distance <= this.data.attackRange) {
            this.el.sceneEl.components['game-manager'].gameLose();
            return;
          }
          
          // ì• ë‹ˆë©”ì´ì…˜
          if (this.currentAnimation !== 'ZombieRunning') {
            this.playAnimation('ZombieRunning');
          }
        },

        playAnimation: function(newAnim) {
          if (this.currentAnimation === newAnim || !this.actions) return;
          
          if (this.actions[this.currentAnimation]) {
            this.actions[this.currentAnimation].fadeOut(0.5);
          }
          
          if (this.actions[newAnim]) {
            this.actions[newAnim]
              .reset()
              .fadeIn(0.5)
              .play();
            
            this.currentAnimation = newAnim;
          }
        }
      });

      AFRAME.registerComponent('zombie-spawner', {
        schema : {
            enabled: {default: true}
            
        },
        init: function() {
          this.spawnTimer = 0;
          this.difficultyTimer = 0;
          this.spawnInterval = 10000; // 10ì´ˆë§ˆë‹¤ ìŠ¤í°
          this.zombieSpeed = 0.1;     // ì´ˆê¸° ì¢€ë¹„ ì†ë„
          this.initialDelay = 5000;   // 5ì´ˆ í›„ ì²« ìŠ¤í°
          this.hasStartedSpawning = false;
          
          this.el.sceneEl.addEventListener('gameStarted', () => {
            setTimeout(() => {
              this.hasStartedSpawning = true;
              this.spawnZombie();
            }, this.initialDelay);
          });
        },

        tick: function(time, deltaTime) {
          if (!this.hasStartedSpawning || 
              this.el.sceneEl.components['game-manager'].isGameOver ||
              this.el.sceneEl.components['game-manager'].isPaused) {
            return;
          }

          this.spawnTimer += deltaTime;
          this.difficultyTimer += deltaTime;
          
          // ë§¤ 30ì´ˆë§ˆë‹¤ ì¢€ë¹„ ì†ë„ ì¦ê°€
          if (this.difficultyTimer >= 30000) {
            this.difficultyTimer = 0;
            this.zombieSpeed += 0.02;
          }
          
          if (this.spawnTimer >= this.spawnInterval) {
            this.spawnTimer = 0;
            this.spawnZombie();
          }
        },

        spawnZombie: function() {
          const minX = -8;
          const maxX = 40;
          const minZ = -140;
          const maxZ = 35;

          const randomX = minX + Math.random() * (maxX - minX);
          const randomZ = minZ + Math.random() * (maxZ - minZ);

          const newZombie = document.createElement('a-entity');
          newZombie.setAttribute('id', 'zombie-' + Date.now());
          newZombie.setAttribute('gltf-model', './models/zombie/scene.gltf');
          newZombie.setAttribute('scale', '0.02 0.02 0.02');
          newZombie.setAttribute('animation-mixer', '');
          newZombie.setAttribute('position', `${randomX} 0 ${randomZ}`);
          
          newZombie.setAttribute('dynamic-body', {
            shape: 'box',
            width: 0.5,
            height: 2,
            depth: 0.5
          });
          
          newZombie.setAttribute('collision-filter', {
            collidesWith: 'building, player',
            group: 'zombie'
          });

          // ì†ë„ë¥¼ 0.1ë¡œ ì„¤ì •
          newZombie.setAttribute('zombie-ai', {
            target: '#character',
            speed: this.zombieSpeed,
            detectionRange: 99999,
            attackRange: 1
          });

          this.el.sceneEl.appendChild(newZombie);
          console.log('New zombie spawned at:', randomX, 0, randomZ);

          // ì¢€ë¹„ ìƒì„± í›„ ì´ë²¤íŠ¸ ë°œìƒ
          this.el.sceneEl.emit('zombieSpawned');
        }
      });
    </script>
</head>
<body>
    <a-scene loading-screen="dotsColor: white; backgroundColor: #000000" game-manager physics>
        <a-assets>
            <a-asset-item id="map-city-01" src="/aframe/maps/city_low_poly_free/scene.gltf"></a-asset-item>

        </a-assets>
        <!-- ë°°ê²½ ì¶”ê°€ -->
        <a-entity
            id="map"
            gltf-model="#map-city-01"
            position="0 -2 0"
            scale="1 1 1"
            rotation="0 0 0"
            static-body="shape: mesh"
            physics-model="type: static">
        </a-entity>

        <!-- ì¡°ëª… -->
        <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
        <a-light type="directional" color="#ffffff" intensity="1" position="-1 2 1"></a-light>

        <!-- ë°”ë‹¥ ì¶”ê°€ -->
        <a-plane 
            position="15 -2 -80" 
            rotation="-90 0 0" 
            scale="1 3 1"
            width="100" 
            height="100" 
            material="
                color: #7BC8A4;
                wireframe: true;
                wireframeLinewidth: 2;
                src: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAEQSURBVHic7ZjBDYQwDARPKYSH9N9NekgJz4MQsuPY3mSllXYeYGac9badX+f9+Nw93+f9+AIwxoAxBowxYIwBYwwYY8AYA8YYMMaAMQaMMWCMAWMMGGPAGAPGGDDGgDEGjDFgzO0Abre0Y8f+HTk/eu2j86s4/n0PYAVgjAFjDBhjwBgDxhgwxoAxBowxYIwBYwwYY8AYA8YYMMaAMQaMMWCMAWMMGGPAmNsBsP8JzHZ+FQaMMWCMAWMMGGPAGAPGGDDGgDEGjDFgjAFjDBhjwBgDxhgw5guNjCTwPZGG1gAAAABJRU5ErkJggg==);
                repeat: 100 100"
            shadow
            static-body>
        </a-plane>

        <!-- 3D ëª¨ë¸ -->
        <a-entity
            id="character"
            gltf-model="./models/player/player.gltf"
            position="0 0 0"
            scale="0.01 0.01 0.01"
            rotation="0 0 0"
            character-movement
            dynamic-body="
                shape: auto; 
                width: 0.5; 
                height: 2; 
                depth: 0.5;
                mass: 1;
                linearDamping: 0.99;
                angularDamping: 0.99;
            "
            collision-filter="
                collidesWith: building, zombie; 
                group: player;
                collisionForces: true
            ">
        </a-entity>

        <!-- 3ì¸ì¹­ ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸ -->
        <a-entity 
            id="camera" 
            camera 
            position="0 2 5"
            unreal-camera-control="
              target: #character; 
              distance: 5; 
              height: 3.5;
              rotationSpeed: 0.002; 
              smoothFactor: 0.1;
              tiltAngle: -10">
            <a-cursor color="#FAFAFA"></a-cursor>
        </a-entity>

        <!-- ì¢€ë¹„ ìŠ¤í¬ë„ˆ -->
        <a-entity id="zombie-spawner" zombie-spawner="enabled: true"></a-entity>
        
        <!-- ì´ˆê¸° ì¢€ë¹„ëŠ” ì œê±° (ìŠ¤í¬ë„ˆê°€ ìƒì„±í•  ê²ƒì´ë¯€ë¡œ) -->
        <a-entity map-hitboxes></a-entity>
    </a-scene>
    <div id="gameOverScreen" style="display: none;">
      <div id="gameOverMessage"></div>
      <div id="recordsList"></div>
      <button onclick="location.reload()">ë‹¤ì‹œ ì‹œì‘</button>
    </div>
</body>
</html>
